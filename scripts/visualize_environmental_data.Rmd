---
title: "Visualize Annual Environmental Data"
author: "Owen Liu, Jameal Samhouri"
date: "5/25/2021"
output: html_document
---


```{r setup, include=FALSE}
library(tidyverse)
library(tidync)
library(here)
library(zoo)
library(lubridate)
library(here)
# library(ncdf4)
library(raster)
library(tabularaster)
library(viridis)
library(ggsci)
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=F)
```

# Purpose

Take the rasterized annual outputs from projected ROMS and visualize them with maps and timeseries. The environmental data have already been extracted and summarized for temperature and oxygen, such that the value for each cell has either mean bottom temperature or mean bottom oxygen, across the season from May to October.

There are 6 projection types total, corresponding to three GCMs (IPSL, Hadley, and GFDL) and two environmental variables (temperature and oxygen)

# Import Data

Import the raster data into stacks

```{r}
# organize the file names we want to import
x <- list.files(here('data','Projection Rasters','Rasters_2d_Survey_Months'),full.names=T,pattern = ".grd")
gfdl_bt_fl <- x[grepl('gfdl_bt',x)]
gfdl_o_fl <- x[grepl('gfdl_oxygen',x)]
had_bt_fl <- x[grepl('had_bt',x)]
had_o_fl <- x[grepl('had_oxygen',x)]
ipsl_bt_fl <- x[grepl('ipsl_bt',x)]
ipsl_o_fl <- x[grepl('ipsl_oxygen',x)]
```

Import the rds file containing the direct extraction and summary values from the ncdf files.

```{r}

df_summ <- read_rds(here('data','mean_bt_ox_allmodels_1980_2100.rds'))

# df_summ %>%
#   group_by(year, lat) %>%
#   summarise(
#     mean_bt_gfdl = mean(mean_bt_gfdl)
#   ) %>%
#   filter( lat == 30.0 )
  

```

# Visualize

We'll try a few different visualizations, writing functions for each that:

* import a raster stack using a list of file names (created above)
* summarize the data somehow
* output a plot or return a dataframe

## Mean Conditions

```{r}
mean_raster <- function(file_list){
  # import files into a raster stack
  s <- stack(file_list)
  # take the mean
  m <- mean(s)
  # label for plot
  pt <- case_when(
    grepl('ipsl_oxygen',file_list[1]) ~ "IPSL Oxygen",
    grepl('ipsl_bt',file_list[1]) ~ "IPSL Temperature",
    grepl('gfdl_oxygen',file_list[1]) ~ "GFDL Oxygen",
    grepl('gfdl_bt',file_list[1]) ~ "GFDL Temperature",
    grepl('had_oxygen',file_list[1]) ~ "HAD Oxygen",
    grepl('had_bt',file_list[1]) ~ "HAD Temperature",
  )
  # plot
  plot(m,main=pt,col=cividis(256))
}
```
Try it out

```{r}
purrr::map(list(gfdl_bt_fl,had_bt_fl,ipsl_bt_fl,gfdl_o_fl,had_o_fl,ipsl_o_fl), mean_raster)
```

## Time Series

First, a latitude-binned time series of mean values from the raster stack

```{r}
plot_ts <- function(file_list,return_plot=T){
  # import files into a raster stack
  s <- stack(file_list)
  yrs <- 1980:2100
  # convert to tibble
  sdf <- s %>% as_tibble(xy=T) %>% 
    #split into bins
    mutate(bin=findInterval(y,vec=seq(30,50,by=5)),
           year=yrs[dimindex]) %>% 
    # summarize by latitude bin
    group_by(year,bin) %>% 
    summarise(m=mean(cellvalue,na.rm=T)) %>% 
    ungroup()
  if(return_plot){
    # create labels for latitude bins
    sdf <- sdf %>% 
      mutate(latbin=case_when(
        bin==1 ~ "30-35",
        bin==2 ~ "35-40",
        bin==3 ~ "40-45",
        bin==4 ~ ">45"
      ))
    # label for plot
    pt <- case_when(
      grepl('ipsl_oxygen',file_list[1]) ~ "IPSL Oxygen",
      grepl('ipsl_bt',file_list[1]) ~ "IPSL Temperature",
      grepl('gfdl_oxygen',file_list[1]) ~ "GFDL Oxygen",
      grepl('gfdl_bt',file_list[1]) ~ "GFDL Temperature",
      grepl('had_oxygen',file_list[1]) ~ "HAD Oxygen",
      grepl('had_bt',file_list[1]) ~ "HAD Temperature",
    )
    lab <- ifelse(grepl('bt',file_list[1]),"Bottom Temperature","Bottom Oxygen")
    # make plot
    p <- sdf %>% 
      ggplot(aes(year,m,col=fct_reorder(latbin,bin)))+
      geom_line()+
      scale_color_locuszoom()+
      labs(x='Year',y=paste("Mean",lab),col="Latitude",title=pt)+
      theme_minimal()
    return(p)
  } else return(sdf)
}
```

Try it out

```{r}
purrr::map(list(gfdl_bt_fl,had_bt_fl,ipsl_bt_fl,gfdl_o_fl,had_o_fl,ipsl_o_fl), plot_ts)
```

Second, a latitude-binned time series of mean values from the direct extraction

```{r}
df_name <- df_summ
var_name <- "mean_bt_gfdl"
plot_ts_direct <- function(df_name, var_name, return_plot=T){
  
  #df_name$year = as.factor(df_name$year) # tried this to fix and did not help
  
  sdf <- df_name %>% #as_tibble(xy=T) %>% 
    #split into bins
    mutate(bin=findInterval(lat,vec=seq(30,50,by=5))) %>% 
    # summarize by latitude bin
    group_by(year, bin) %>% 
    summarise( #m2 = mean(mean_bt_gfdl))
      m=mean(.data[[var_name]],na.rm=T)
      ) %>% # this is producing a value that does not change between 1980-2100
    ungroup()
  if(return_plot){
    # create labels for latitude bins
    sdf <- sdf %>% 
      mutate(latbin=case_when(
        bin==1 ~ "30-35",
        bin==2 ~ "35-40",
        bin==3 ~ "40-45",
        bin==4 ~ ">45"
      ))
    # label for plot
    pt <- case_when(
      grepl('oxy_bottom_ipsl',var_name) ~ "IPSL Oxygen",
      grepl('mean_bt_ipsl',var_name) ~ "IPSL Temperature",
      grepl('mean_oxy_bottom_gfdl',var_name) ~ "GFDL Oxygen",
      grepl('mean_bt_gfdl',var_name) ~ "GFDL Temperature",
      grepl('mean_oxy_bottom_hadl',var_name) ~ "HAD Oxygen",
      grepl('mean_bt_hadl',var_name) ~ "HAD Temperature",
    )
    lab <- ifelse(grepl('bt',var_name),"Bottom Temperature","Bottom Oxygen")
    # make plot
    p <- sdf %>% 
      ggplot(aes(year,m,col=fct_reorder(latbin,bin)))+
      geom_line()+
      scale_color_locuszoom()+
      labs(x='Year',y=paste("Mean",lab),col="Latitude",title=pt)+
      theme_minimal()
    return(p)
  } else return(sdf)
}
```

Try it out

```{r}
# i want to apply purrr::map  across a list of var_name using the function plot_ts_direct() with other arguments set to constant
purrr::map(c("mean_bt_gfdl", "mean_bt_ipsl", "mean_bt_hadl", "mean_oxy_bottom_gfdl","oxy_bottom_ipsl","mean_oxy_bottom_hadl"), plot_ts_direct, df_name = df_summ, return_plot=T) 
```

And save a tibble

```{r}

latbins_summ <- purrr::map_df(c("mean_bt_gfdl", "mean_bt_ipsl", "mean_bt_hadl", "mean_oxy_bottom_gfdl","oxy_bottom_ipsl","mean_oxy_bottom_hadl"), plot_ts_direct, df_name = df_summ, return_plot=F)

```

# Make some maps based on the directly extracted summary data
```{r}

library(cmocean)

map1 <- ggplot(data=df_summ, aes(x=lat, y=long))+
  geom_tile(aes(fill=mean_bt_gfdl))+
  theme_classic() +  labs(y="", x="", title = "mean_bt_gfdl") +   theme(legend.position="right",legend.title = element_blank())+
  theme( panel.border = element_rect(colour = "black", fill=NA, size=1)) + #makes a box
  scale_fill_gradientn(colours = cmocean("dense")(256)) +
  annotation_map(map_data("world"), colour = "black", fill="grey50")+
  coord_quickmap(xlim=c(-134,-115.8),ylim=c(30,48)) +  #Sets aspect ratio
  scale_x_continuous(expand = c(0, 0)) +  scale_y_continuous(expand = c(0, 0))
map1

```


# Hovmoller plots

Plot latitude and year with the variable represented by colors

